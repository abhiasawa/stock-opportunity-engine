{% extends "base.html" %}
{% block content %}

<!-- Scan Progress Banner (polls /api/scan/status) -->
<div id="scan-banner" style="display:none;" class="scan-progress-banner">
  <div class="scan-progress-inner">
    <div class="scan-spinner"></div>
    <div class="scan-progress-text">
      <div class="scan-phase" id="scan-message">Starting scan...</div>
      <div class="scan-detail" id="scan-detail"></div>
    </div>
    <div class="scan-progress-bar-wrap">
      <div class="scan-progress-bar" id="scan-bar" style="width: 0%"></div>
    </div>
    <span class="scan-pct" id="scan-pct">0%</span>
  </div>
</div>

{% if run and run.summary %}
<!-- KPI Row -->
<div class="kpi-row">
  <div class="kpi-item">
    <div class="kpi-label">Universe</div>
    <div class="kpi-value">{{ run.summary.universe_size }}</div>
    <div class="kpi-sub">Total stocks loaded</div>
  </div>
  <div class="kpi-item">
    <div class="kpi-label">Eligible</div>
    <div class="kpi-value">{{ run.summary.eligible_universe }}</div>
    <div class="kpi-sub">Passed universe filters</div>
  </div>
  <div class="kpi-item">
    <div class="kpi-label">Passed Filters</div>
    <div class="kpi-value">{{ run.summary.passed_filters }}</div>
    <div class="kpi-sub">Quality + growth screened</div>
  </div>
  <div class="kpi-item">
    <div class="kpi-label">Opportunities</div>
    <div class="kpi-value green">{{ run.summary.recommended_count }}</div>
    <div class="kpi-sub">Top scored picks</div>
  </div>
</div>

<!-- Status Bar -->
<div class="action-bar">
  <span class="meta">
    Last scan: {{ run.started_at[:19] }} &middot;
    {% if run.status == "completed" %}
    <span class="badge badge-success"><span class="badge-dot"></span> Completed</span>
    {% elif run.status == "failed" %}
    <span class="badge badge-danger"><span class="badge-dot"></span> Failed</span>
    {% else %}
    <span class="badge badge-warning"><span class="badge-dot"></span> Running</span>
    {% endif %}
  </span>
</div>

{% if recommendations %}
<!-- Summary Row -->
<div class="two-col">
  <div class="card">
    <h2>Sector Breakdown</h2>
    {% set sectors = {} %}
    {% for r in recommendations %}
      {% if r.sector in sectors %}
        {% set _ = sectors.update({r.sector: sectors[r.sector] + 1}) %}
      {% else %}
        {% set _ = sectors.update({r.sector: 1}) %}
      {% endif %}
    {% endfor %}
    <div class="sector-chips" style="margin-top: 10px;">
      {% for sector, count in sectors.items() %}
      <div class="sector-chip">{{ sector }} <span class="count">{{ count }}</span></div>
      {% endfor %}
    </div>
  </div>
  <div class="card">
    <h2>Top Pick</h2>
    {% set top = recommendations[0] %}
    <div class="top-pick">
      <div class="rank rank-1">1</div>
      <div>
        <a href="https://www.screener.in/company/{{ top.symbol | screener_encode }}/" target="_blank" class="top-pick-symbol">{{ top.symbol }}</a>
        <div class="top-pick-name">{{ top.name }} &middot; {{ top.sector }}</div>
      </div>
      <div class="top-pick-score">
        {{ "%.1f"|format(top.final_score) }}
        <div class="top-pick-score-label">Final Score</div>
      </div>
    </div>
    <div class="score-grid">
      <div class="score-grid-item sg-profit"><div class="label">Profit</div><div class="value">{{ "%.0f"|format(top.score_breakdown.profit_trend) }}</div></div>
      <div class="score-grid-item sg-value"><div class="label">Value</div><div class="value">{{ "%.0f"|format(top.score_breakdown.valuation) }}</div></div>
      <div class="score-grid-item sg-events"><div class="label">Events</div><div class="value">{{ "%.0f"|format(top.score_breakdown.future_events) }}</div></div>
      <div class="score-grid-item sg-quality"><div class="label">Quality</div><div class="value">{{ "%.0f"|format(top.score_breakdown.quality) }}</div></div>
      <div class="score-grid-item sg-risk"><div class="label">Risk</div><div class="value">{{ "%.0f"|format(top.score_breakdown.risk_penalty) }}</div></div>
    </div>
  </div>
</div>

<!-- Recommendations Table -->
<div class="card">
  <div class="card-header">
    <h2>All Recommendations</h2>
    <a class="btn btn-secondary btn-sm" href="/runs/{{ run.id }}">Full Detail</a>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th class="text-center">#</th>
          <th>Stock</th>
          <th>Sector</th>
          <th class="text-right">Score</th>
          <th class="text-center">Breakdown</th>
          <th class="text-right">PE</th>
          <th class="text-right">MCap (Cr)</th>
          <th>Events</th>
          <th>Reasons</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in recommendations %}
        <tr class="rec-row" onclick="toggleMetrics({{ loop.index }})" style="cursor:pointer;">
          <td class="text-center">
            {% if r.rank <= 3 %}
            <span class="rank rank-{{ r.rank }}">{{ r.rank }}</span>
            {% else %}
            <span class="rank rank-default">{{ r.rank }}</span>
            {% endif %}
          </td>
          <td>
            <a href="https://www.screener.in/company/{{ r.symbol | screener_encode }}/" target="_blank" class="td-symbol" onclick="event.stopPropagation();">{{ r.symbol }}</a>
            <div class="td-name">{{ r.name }}</div>
          </td>
          <td><span class="tag tag-blue">{{ r.sector }}</span></td>
          <td class="text-right">
            {% set sc = "high" if r.final_score >= 65 else ("mid" if r.final_score >= 40 else "low") %}
            <span class="score-pill {{ sc }}">
              {{ "%.1f"|format(r.final_score) }}
              <span class="score-bar"><span class="score-bar-fill {{ sc }}" style="width: {{ r.final_score }}%"></span></span>
            </span>
          </td>
          <td class="text-center">
            <div class="breakdown" title="P:{{ "%.0f"|format(r.score_breakdown.profit_trend) }} V:{{ "%.0f"|format(r.score_breakdown.valuation) }} E:{{ "%.0f"|format(r.score_breakdown.future_events) }} Q:{{ "%.0f"|format(r.score_breakdown.quality) }} R:{{ "%.0f"|format(r.score_breakdown.risk_penalty) }}">
              <div class="breakdown-bar bar-profit" style="height: {{ [r.score_breakdown.profit_trend * 0.28, 2]|max }}px;"></div>
              <div class="breakdown-bar bar-value" style="height: {{ [r.score_breakdown.valuation * 0.28, 2]|max }}px;"></div>
              <div class="breakdown-bar bar-events" style="height: {{ [r.score_breakdown.future_events * 0.28, 2]|max }}px;"></div>
              <div class="breakdown-bar bar-quality" style="height: {{ [r.score_breakdown.quality * 0.28, 2]|max }}px;"></div>
              <div class="breakdown-bar bar-risk" style="height: {{ [r.score_breakdown.risk_penalty * 0.28, 2]|max }}px;"></div>
            </div>
          </td>
          <td class="td-num">{{ "%.1f"|format(r.pe) }}</td>
          <td class="td-num">{{ "%.0f"|format(r.market_cap_cr) }}</td>
          <td>
            {% if r.event_count > 0 %}
            <span class="tag tag-amber">{{ r.event_count }} event{{ "s" if r.event_count > 1 }}</span>
            {% else %}
            <span class="meta">--</span>
            {% endif %}
          </td>
          <td>
            {% for reason in r.reasons[:2] %}
            <span class="tag">{{ reason }}</span>
            {% endfor %}
          </td>
          <td class="text-center">
            <span class="expand-icon" id="expand-icon-{{ loop.index }}">&#9662;</span>
          </td>
        </tr>
        <!-- Expandable Metrics Row -->
        <tr class="metrics-row" id="metrics-{{ loop.index }}" style="display:none;">
          <td colspan="10" style="padding: 0;">
            {% set m = r.metrics or {} %}
            <div class="metrics-panel">
              <div class="metrics-grid">
                <div class="metric-item">
                  <div class="metric-label">Current Price</div>
                  <div class="metric-value">{{ "%.2f"|format(m.get("current_price", 0)) if m.get("current_price") else "--" }}</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Book Value</div>
                  <div class="metric-value">{{ "%.2f"|format(m.get("book_value", 0)) if m.get("book_value") else "--" }}</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Price / Book</div>
                  <div class="metric-value">{{ "%.2f"|format(m.get("price_to_book", 0)) if m.get("price_to_book") else "--" }}</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Dividend Yield</div>
                  <div class="metric-value">{{ "%.2f"|format(m.get("dividend_yield", 0)) }}%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">ROE</div>
                  <div class="metric-value {% if m.get('roe', 0) >= 15 %}text-green{% elif m.get('roe', 0) >= 10 %}text-amber{% else %}text-red{% endif %}">{{ "%.2f"|format(m.get("roe", 0)) }}%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">ROCE</div>
                  <div class="metric-value {% if m.get('roce', 0) >= 15 %}text-green{% elif m.get('roce', 0) >= 10 %}text-amber{% else %}text-red{% endif %}">{{ "%.2f"|format(m.get("roce", 0)) }}%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Sales (Cr)</div>
                  <div class="metric-value">{{ "%.0f"|format(m.get("sales_cr", 0)) if m.get("sales_cr") else "--" }}</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Op. Profit (Cr)</div>
                  <div class="metric-value">{{ "%.0f"|format(m.get("operating_profit_cr", 0)) if m.get("operating_profit_cr") else "--" }}</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Net Worth (Cr)</div>
                  <div class="metric-value">{{ "%.0f"|format(m.get("net_worth_cr", 0)) if m.get("net_worth_cr") else "--" }}</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Debt (Cr)</div>
                  <div class="metric-value">{{ "%.0f"|format(m.get("debt_cr", 0)) if m.get("debt_cr") else "--" }}</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">Promoter Hold.</div>
                  <div class="metric-value">{{ "%.1f"|format(m.get("promoter_holding_pct", 0)) }}%</div>
                </div>
                <div class="metric-item">
                  <div class="metric-label">52W High / Low</div>
                  <div class="metric-value">{{ "%.0f"|format(m.get("high_52w", 0)) }} / {{ "%.0f"|format(m.get("low_52w", 0)) }}</div>
                </div>
              </div>
              <div style="margin-top: 8px;">
                <a href="https://www.screener.in/company/{{ r.symbol | screener_encode }}/" target="_blank" class="btn btn-secondary btn-sm">View on Screener &rarr;</a>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Score Legend -->
<div class="card">
  <div class="legend">
    <div class="legend-item"><span class="legend-dot" style="background:var(--green);"></span> Profit Trend (35%)</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--teal);"></span> Valuation (20%)</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--amber);"></span> Future Events (25%)</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--purple);"></span> Quality (10%)</div>
    <div class="legend-item"><span class="legend-dot" style="background:var(--red);"></span> Risk Penalty (10%)</div>
  </div>
</div>
{% endif %}

{% elif run and run.error_text %}
<div class="card">
  <h2>Scan Failed</h2>
  <div class="alert alert-error">{{ run.error_text }}</div>
</div>

{% else %}
<!-- Empty State — initial scan is running in background -->
<div class="card">
  <div class="empty-state">
    <h3>Setting Up</h3>
    <p>Your first scan is running automatically in the background. This page will refresh when data is ready.</p>
    <p class="meta">Fetching fundamentals for all stocks — this takes a few minutes on first run.</p>
  </div>
</div>
{% endif %}

<script>
function toggleMetrics(idx) {
  var row = document.getElementById('metrics-' + idx);
  var icon = document.getElementById('expand-icon-' + idx);
  if (row.style.display === 'none') {
    row.style.display = '';
    icon.innerHTML = '&#9652;';
  } else {
    row.style.display = 'none';
    icon.innerHTML = '&#9662;';
  }
}

// Poll scan status
(function() {
  var banner = document.getElementById('scan-banner');
  var msgEl = document.getElementById('scan-message');
  var detailEl = document.getElementById('scan-detail');
  var barEl = document.getElementById('scan-bar');
  var pctEl = document.getElementById('scan-pct');
  var wasRunning = false;

  function poll() {
    fetch('/api/scan/status')
      .then(function(r) { return r.json(); })
      .then(function(s) {
        if (s.running) {
          banner.style.display = 'block';
          msgEl.textContent = s.message || 'Scanning...';
          detailEl.textContent = s.symbol ? ('Current: ' + s.symbol) : '';
          barEl.style.width = s.pct + '%';
          pctEl.textContent = s.pct + '%';
          wasRunning = true;
        } else {
          banner.style.display = 'none';
          if (wasRunning) {
            // Scan just finished — reload to show results
            wasRunning = false;
            window.location.reload();
          }
        }
      })
      .catch(function() {});
  }

  poll();
  setInterval(poll, 2000);
})();
</script>

{% endblock %}
